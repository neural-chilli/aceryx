{% extends "layouts/base.html" %}

{% block title %}Create Flow - Aceryx{% endblock %}

{% block header %}
<div class="row g-2 align-items-center">
    <div class="col">
        <h2 class="page-title">Create New Flow</h2>
        <div class="text-muted mt-1">Build a new AI workflow</div>
    </div>
    <div class="col-auto ms-auto d-print-none">
        <a href="/flows" class="btn btn-outline-secondary">
            <svg class="icon"><use xlink:href="#tabler-arrow-left"></use></svg>
            Back to Flows
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Flow Details</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label required">Flow Name</label>
                    <input type="text" class="form-control" name="name" placeholder="Enter flow name" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="3" placeholder="Describe what this flow does"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tags</label>
                    <input type="text" class="form-control" name="tags" placeholder="production, api, automation">
                    <div class="form-hint">Separate tags with commas</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Template</label>
                    <div class="row">
                        {% for template in templates %}
                        <div class="col-md-6 mb-2">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="template" value="{{ template.id }}" class="form-selectgroup-input" {% if loop.first %}checked{% endif %}>
                                <span class="form-selectgroup-label">
                                    <div>
                                        <strong>{{ template.name }}</strong>
                                        <div class="text-muted">{{ template.description }}</div>
                                    </div>
                                </span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="card-footer text-end">
                <button type="button" class="btn btn-outline-secondary me-2">Save as Draft</button>
                <button type="button" class="btn btn-primary" onclick="createFlow()">Create & Design</button>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Available Tools</h3>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for tool in available_tools[:5] %}
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="badge bg-blue">{{ tool.category }}</span>
                            </div>
                            <div class="col">
                                <div class="text-truncate">
                                    <strong>{{ tool.name }}</strong>
                                </div>
                                <div class="text-muted">{{ tool.description[:50] }}...</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <a href="/tools" class="btn btn-outline-primary w-100">View All Tools</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function createFlow() {
        const formData = {
            name: document.querySelector('input[name="name"]').value,
            description: document.querySelector('textarea[name="description"]').value,
            tags: document.querySelector('input[name="tags"]').value.split(',').map(t => t.trim()).filter(t => t),
            template: document.querySelector('input[name="template"]:checked').value
        };

        if (!formData.name) {
            alert('Please enter a flow name');
            return;
        }

        fetch('/api/v1/flows', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    window.location.href = `/flows/${data.id}/design`;
                } else {
                    alert('Error creating flow: ' + (data.error?.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating flow');
            });
    }
</script>
{% endblock %}